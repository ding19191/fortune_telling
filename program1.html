<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸ä¸ç±¤è©©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap');
        
        :root {
            --temple-red: #8b0000;
            --paper-bg: #fffcf0;
            --gold: #d4af37;
        }

        body {
            font-family: 'Noto Serif TC', serif;
            background-color: #f3f0e9;
            color: #333;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }

        .stick-box-anim {
            animation: barrelShake 0.4s infinite;
        }

        @keyframes barrelShake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(8deg) translateY(-5px); }
            75% { transform: rotate(-8deg) translateY(-5px); }
        }

        .vertical-layout {
            display: flex;
            flex-direction: row-reverse;
            justify-content: center;
            gap: 1.25rem;
            padding: 2rem 0.5rem;
            min-height: 240px;
        }

        .vertical-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 1.35rem;
            font-weight: 700;
            line-height: 1.5;
            letter-spacing: 0.2em;
            color: #1a1a1a;
            border-left: 1px dashed rgba(139, 0, 0, 0.1);
            padding-left: 0.5rem;
        }

        .jiaobe {
            width: 60px; height: 32px;
            background: linear-gradient(145deg, #a52a2a, #800000);
            border-radius: 50% 50% 10% 10% / 100% 100% 20% 20%;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .jiaobe.flat {
            transform: scaleY(0.4);
            border-radius: 10% 10% 50% 50% / 20% 20% 100% 100%;
            background: linear-gradient(145deg, #8b2525, #6b0000);
        }

        .ai-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            padding: 1.5rem;
            line-height: 2;
            font-size: 1rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .lotus-loader {
            width: 40px;
            height: 40px;
            border: 3px solid var(--temple-red);
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .btn-temple {
            background: var(--temple-red);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            font-weight: bold;
            box-shadow: 0 4px 0 #5a0000;
            transition: all 0.1s;
        }

        .btn-temple:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #5a0000;
        }

        .btn-temple:disabled {
            background: #a0a0a0;
            box-shadow: 0 4px 0 #707070;
            opacity: 0.7;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 md:p-8">

    <div class="w-full max-w-lg bg-[#fffcf0] border-4 border-double border-[var(--temple-red)] shadow-2xl rounded-lg overflow-hidden flex flex-col relative">
        
        <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-amber-500"></div>
        <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-amber-500"></div>
        <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-amber-500"></div>
        <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-amber-500"></div>

        <div class="bg-[var(--temple-red)] text-amber-100 py-8 text-center border-b-8 border-double border-amber-600">
            <h1 class="text-4xl font-bold tracking-[0.3em] mb-2">ä¸ä¸ç±¤è©©</h1>
            <div class="flex items-center justify-center gap-2">
                <span class="h-px w-8 bg-amber-400"></span>
                <p class="text-xs tracking-[0.2em] uppercase opacity-90">Digital Divinity & Insight</p>
                <span class="h-px w-8 bg-amber-400"></span>
            </div>
        </div>

        <div class="p-6 md:p-8 flex-grow flex flex-col min-h-[500px]">
            <div id="step-input" class="space-y-8 py-4">
                <div class="text-center space-y-3">
                    <p class="text-red-900 font-bold text-xl">å¼Ÿå­/ä¿¡å¥³ èª å¿ƒè«‹ç¤º</p>
                    <p class="text-stone-500 text-sm italic px-6 leading-relaxed">è«‹ç«¯åéœå¿ƒï¼Œæ–¼è…¦æµ·ä¸­é»˜å¿µå§“åã€ä½å€èˆ‡æ‰€æ±‚ä¹‹äº‹ã€‚</p>
                </div>
                <div class="relative">
                    <textarea id="question" class="w-full p-6 border-2 border-stone-300 rounded-xl focus:ring-4 focus:ring-red-100 focus:border-red-800 outline-none h-40 bg-white text-lg transition-all shadow-inner resize-none" placeholder="ä¾‹å¦‚ï¼šå•è¿‘æœŸäº‹æ¥­ç™¼å±•ã€æ„Ÿæƒ…é‹å‹¢..."></textarea>
                    <div class="absolute bottom-3 right-3 text-stone-300 pointer-events-none">ä¸ä¸é–£å°</div>
                </div>
                <button onclick="toDraw()" class="w-full btn-temple text-xl tracking-widest">é–‹å§‹è«‹ç±¤</button>
            </div>

            <div id="step-draw" class="hidden text-center space-y-12 py-12">
                <div class="relative inline-block">
                    <div id="barrel" class="text-9xl transition-transform filter drop-shadow-xl">ğŸº</div>
                    <div class="absolute -bottom-4 left-1/2 -translate-x-1/2 w-24 h-4 bg-black/10 blur-md rounded-full"></div>
                </div>
                <p class="text-stone-700 font-bold text-lg">æ–å‹•ç±¤ç­’ç›´è‡³éˆç±¤è½åœ°</p>
                <button onclick="startShake()" id="shake-btn" class="w-full btn-temple text-lg">æ–å‹•ç±¤ç­’</button>
            </div>

            <div id="step-jiao" class="hidden text-center space-y-10 py-6">
                <div class="bg-amber-50 py-4 border-y-2 border-amber-200 shadow-sm">
                    <p class="text-stone-500 text-xs mb-1">å·²ç‚ºæ‚¨æŠ½å¾—éˆç±¤</p>
                    <p id="target-stick" class="text-3xl font-black text-red-900 tracking-widest"></p>
                </div>
                <div class="flex justify-center space-x-16 py-8 h-32 items-center">
                    <div id="j1" class="jiaobe"></div>
                    <div id="j2" class="jiaobe"></div>
                </div>
                <p id="jiao-result" class="h-10 font-bold text-2xl flex items-center justify-center"></p>
                <button onclick="throwJiao()" id="jiao-btn" class="w-full btn-temple text-lg">æ“²ç­Šç¢ºèª (è–ç­Šç‚ºæº–)</button>
            </div>

            <div id="step-result" class="hidden space-y-6">
                <div class="bg-[var(--paper-bg)] border-2 border-red-800 p-6 shadow-xl relative overflow-hidden">
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 opacity-[0.03] pointer-events-none text-9xl">ç¦</div>
                    <h2 id="final-stick-id" class="text-center font-bold text-red-900 text-2xl mb-6 border-b-2 border-red-100 pb-4 tracking-tighter"></h2>
                    <div id="poem-box" class="vertical-layout"></div>
                    <div id="ai-response" class="mt-8 pt-6 border-t-2 border-dashed border-red-300">
                        <div class="flex items-center mb-4">
                            <div class="w-3 h-3 bg-red-800 rotate-45 mr-3"></div>
                            <span class="font-bold text-red-900 text-lg">ä¸ä¸è§£å¦æŒ‡å¼•ï¼š</span>
                        </div>
                        <div id="ai-text" class="ai-card text-stone-800 whitespace-pre-wrap leading-relaxed"></div>
                    </div>
                </div>
                <button onclick="resetGame()" class="w-full py-4 bg-stone-100 text-stone-600 rounded-lg font-bold border-2 border-stone-200 hover:bg-white transition-colors">åŠŸå¾·åœ“æ»¿ï¼Œå†æ¬¡è«‹ç¤º</button>
            </div>
        </div>

        <div class="bg-stone-50 p-3 text-center text-[10px] text-stone-400 border-t border-stone-200">
            åƒ…ä¾›åƒè€ƒèˆ‡å¿ƒéˆè¼”åŠ© Â· ä¸ä¸ AI æé†’æ‚¨å‡¡äº‹ç›¡å¿ƒå‰‡éˆ
        </div>
    </div>

    <script>
async function askAI() {
  const prompt = document.getElementById("prompt").value;

  const res = await fetch("/api/ask", {
    method: "POST",
    body: JSON.stringify({ prompt })
  });

  const data = await res.json();
  document.getElementById("result").innerText =
    data.choices[0].message.content;
}


        const poemLibrary = [
            { id: "ç¬¬ä¸€ç±¤", code: "ç”²å­", lines: ["æ—¥å‡ºä¾¿è¦‹é¢¨é›²æ•£", "å…‰æ˜æ¸…æ·¨ç…§ä¸–é–“", "ä¸€å‘å‰é€”é€šå¤§é“", "è¬äº‹æ¸…å‰ä¿å¹³å®‰"] },
            { id: "ç¬¬äºŒç±¤", code: "ç”²å¯…", lines: ["æ–¼ä»Šæ­¤æ™¯æ­£ç•¶æ™‚", "çœ‹çœ‹æ¬²åç™¾èŠ±é­", "è‹¥èƒ½é‡å¾—æ˜¥è‰²åˆ°", "ä¸€ç‘æ¸…é¦™æ»¿åœ°æ­¸"] },
            { id: "ç¬¬ä¸‰ç±¤", code: "ç”²è¾°", lines: ["å‹¸å›æŠŠå®šå¿ƒè«è™›", "å¤©è¨»è¡£ç¥¿è‡ªæœ‰é¤˜", "å’Œåˆé‡é‡å¸¸å‰æ…¶", "é€ä¾†å…’å¥³æ»¿é–€åº­"] },
            { id: "ç¬¬å››ç±¤", code: "ç”²åˆ", lines: ["é¢¨æ¬æµªéœå¯è¡ŒèˆŸ", "æ°æ˜¯ä¸­ç§‹æœˆä¸€è¼ª", "å‡¡äº‹ä¸é ˆå¤šæ†‚æ…®", "ç¦ç¥¿è‡ªæœ‰æ…¶å®¶é–€"] },
            { id: "ç¬¬äº”ç±¤", code: "ç”²ç”³", lines: ["åªæå‰é€”æ˜æœ‰è®Š", "å‹¸å›ä½œæ€¥å¯å®œå…ˆ", "ä¸”å®ˆé•·æ±Ÿç„¡å¤§äº‹", "å‘½é€¢ç¾…å­›ä¸”å®‰ç„¶"] },
            { id: "ç¬¬å…­ç±¤", code: "ç”²æˆŒ", lines: ["é¢¨è•­è•­å…®æ˜“æ°´å¯’", "å£¯å£«ä¸€å»ä¸å¾©é‚„", "é›–ç„¶æ­¤äº‹é›£æˆå°±", "ä¸”å®ˆå®‰éœä¿å¹³å®‰"] },
            { id: "ç¬¬ä¸ƒç±¤", code: "ä¹™ä¸‘", lines: ["é›²é–‹æœˆå‡ºæ­£åˆ†æ˜", "ä¸é ˆé€²é€€å•å‰ç¨‹", "å©šå§»çš†ç”±å¤©è¨»å®š", "å’Œåˆè‡ªæœ‰å…©åˆ†æ˜"] },
            { id: "ç¬¬å…«ç±¤", code: "ä¹™å¯", lines: ["ç¦¾ç¨»çœ‹çœ‹çµæˆå®Œ", "æ­¤äº‹å¿…å®šå…©ç›¸å…¨", "å›åˆ°å®¶ä¸­å¯¬å¿ƒå", "å¦»å…’é¼“èˆæ…¶åœ˜åœ“"] },
            { id: "ç¬¬ä¹ç±¤", code: "ä¹™å·³", lines: ["é¾è™ç›¸éš¨åœ¨æ·±å±±", "å›çˆ¾ä½•é ˆè‹¦ä¸­é–“", "å¯Œè²´ç”±å¤©ä¸å¯æ±‚", "è¬äº‹æ¸…å‰ä¿å¹³å®‰"] },
            { id: "ç¬¬åç±¤", code: "ä¹™æœª", lines: ["èŠ±é–‹çµå­ä¸€åŠæ¯", "å¯æƒœä»Šå¹´æ±è™›åº¦", "æ¼¸æ¼¸æ—¥è½è¥¿å±±å»", "å‹¸å›ä¸ç”¨å‘å‰é€”"] },
            { id: "ç¬¬åä¸€ç±¤", code: "ä¹™é…‰", lines: ["éˆé›æ¼¸æ¼¸è¦‹åˆ†æ˜", "å‡¡äº‹ä¸”çœ‹å­ä¸‘å¯…", "é›²é–‹æœˆå‡ºç…§å¤©ä¸‹", "éƒå›å³ä¾¿è¦‹å¤ªå¹³"] },
            { id: "ç¬¬åäºŒç±¤", code: "ä¹™äº¥", lines: ["é•·æ±Ÿé¢¨æµªæ¼¸æ¼¸éœ", "äºä»Šå¾—é€²å¯å®‰å¯§", "å¿…æœ‰è²´äººç›¸æ‰¶åŠ©", "å‡¶äº‹è„«å‡ºå ±å¤ªå¹³"] },
            { id: "ç¬¬åä¸‰ç±¤", code: "ä¸™å­", lines: ["å‘½ä¸­æ­£é€¢ç¾…å­›æ˜Ÿ", "ç”¨ç›¡å¿ƒæ©Ÿç¸½æœªä¼‘", "ä½œç¦å•ç¥é›£å¾—é", "æ°æ˜¯è¡ŒèˆŸä¸Šé«˜ç˜"] },
            { id: "ç¬¬åå››ç±¤", code: "ä¸™å¯…", lines: ["è²¡ä¸­æ¼¸æ¼¸è¦‹åˆ†æ˜", "èŠ±é–‹èŠ±è¬çµå­æˆ", "å¯¬å¿ƒä¸”è§£å¾å‰äº‹", "å‰é€”å¾—åˆ©è‡ªäº¨é€š"] },
            { id: "ç¬¬åäº”ç±¤", code: "ä¸™è¾°", lines: ["å…«ååŸä¾†æ˜¯å¤ªå…¬", "çœ‹çœ‹æ™šæ™¯é‡æ–‡ç‹", "ç›®ä¸‹ç·Šäº‹ä¼‘ç›¸å•", "å‹¸å›ä¸”å®ˆå¾…é‹é€š"] },
            { id: "ç¬¬åå…­ç±¤", code: "ä¸™åˆ", lines: ["ä¸é ˆä½œç¦ä¸é ˆæ±‚", "ç”¨ç›¡å¿ƒæ©Ÿç¸½æœªä¼‘", "é™½ä¸–ä¸çŸ¥é™°ä¸–äº‹", "å®˜æ³•å¦‚çˆä¸è‡ªç”±"] },
            { id: "ç¬¬åä¸ƒç±¤", code: "ä¸™ç”³", lines: ["èˆŠæ¨é‡é‡æœªæ”¹ç‚º", "å®¶ä¸­ç¦æ‚£æ­»é–€é–‹", "ä¸‰åƒæ³•å¾‹å…«åƒåˆ¤", "ç½°ç›¡äººé–“ä¸ç™½è²¡"] },
            { id: "ç¬¬åå…«ç±¤", code: "ä¸™æˆŒ", lines: ["å›å•ä¸­é–“æ­¤è¨€å› ", "çœ‹çœ‹ç¥¿é¦¬æ‹±å‰ç¨‹", "è‹¥å¾—è²´äººå¤šå¾—åˆ©", "å’Œåˆè‡ªæœ‰å…©åˆ†æ˜"] },
            { id: "ç¬¬åä¹ç±¤", code: "ä¸ä¸‘", lines: ["å¯Œè²´ç”±å¤©æœ«å¯æ±‚", "è¬äº‹æ¸…å‰ä¿å¹³å®‰", "åªæå‘½å…§æœ‰å·®æ± ", "å…©å®¶åˆå’Œæ˜¯éå¸¸"] },
            { id: "ç¬¬äºŒåç±¤", code: "ä¸å¯", lines: ["å‰é€”åŠŸåæœªå¾—æ„", "åªæå‘½å…§æœ‰å·®æ± ", "å…©å®¶åˆå’Œæ˜¯éå¸¸", "ç©å–„ä¹‹å®¶æ…¶æœ‰é¤˜"] },
            { id: "ç¬¬äºŒåä¸€ç±¤", code: "ä¸å·³", lines: ["åæ–¹ä½›æ³•æœ‰éˆé€š", "å¤§é›£ç¦æ‚£ä¸ç›¸åŒ", "ç´…æ—¥ç•¶ç©ºå¸¸ç…§è€€", "é‚„æœ‰è²´äººåˆ°åºœä¸­"] },
            { id: "ç¬¬äºŒåäºŒç±¤", code: "ä¸æœª", lines: ["å¤ªå…¬å®¶æ¥­å…«åæˆ", "æœˆå‡ºå…‰è¼ç…§å¤§ç¨‹", "è‹¥å•æ±‚è²¡ä¸¦é€²å¯¶", "è¬äº‹æ¸…å‰ä¿å¹³å®‰"] },
            { id: "ç¬¬äºŒåä¸‰ç±¤", code: "ä¸é…‰", lines: ["æ¬²å»é•·æ±Ÿæ°´é—ŠèŒ«", "è¡ŒèˆŸæŠŠå®šæœªé­é¢¨", "æˆ¶å…§ç”¨å¿ƒå†ä½œç¦", "çœ‹çœ‹é‹ªåœ°é»ƒé‡‘æ»¿"] },
            { id: "ç¬¬äºŒåå››ç±¤", code: "ä¸äº¥", lines: ["æœˆå‡ºå…‰è¼æœ¬æ¸…å‰", "æµ®é›²ç¸½æ˜¯è”½é™°è‰²", "æˆ¶å…§ç”¨å¿ƒå†ä½œç¦", "ç•¶å®˜åˆ†ç†ä¾¿ç„¡å¤±"] },
            { id: "ç¬¬äºŒåäº”ç±¤", code: "æˆŠå­", lines: ["ç¸½æ˜¯å‰é€”è«å¿ƒæ€¥", "çœ‹çœ‹å³ä¾¿è¦‹æ˜æœˆ", "è‹¥å¾—è²´äººå¤šå¾—åˆ©", "å’Œåˆè‡ªæœ‰å…©åˆ†æ˜"] },
            { id: "ç¬¬äºŒåå…­ç±¤", code: "æˆŠå¯…", lines: ["é¸å‡ºç‰¡ä¸¹ç¬¬ä¸€æ", "å‹¸å›æŠ˜å–è«é²ç–‘", "ä¸–é–“ç¹è¯çµ‚æœ‰ç›¡", "å¤©ç”Ÿç¦ç¥¿è‡ªéš¨æ™‚"] },
            { id: "ç¬¬äºŒåä¸ƒç±¤", code: "æˆŠè¾°", lines: ["å›çˆ¾å¯¬å¿ƒä¸”è‡ªç”±", "é–€åº­æ¸…å‰å®¶ç„¡æ†‚", "è²¡å¯¶è‡ªç„¶çµ‚æœ‰æœ›", "å‡¡äº‹å¿…æœ‰è²´äººæ‰¶"] },
            { id: "ç¬¬äºŒåå…«ç±¤", code: "æˆŠåˆ", lines: ["æ–¼ä»Šæ­¤æ™¯æ­£ç•¶æ™‚", "çœ‹çœ‹æ¬²åç™¾èŠ±é­", "è‹¥èƒ½é‡å¾—æ˜¥è‰²åˆ°", "ä¸€ç‘æ¸…é¦™æ»¿åœ°æ­¸"] },
            { id: "ç¬¬äºŒåä¹ç±¤", code: "æˆŠç”³", lines: ["æ¯æœ¨å¯æƒœæœªé€¢æ˜¥", "å¦‚ä»Šé‚„åœ¨æš—è™•è—", "å¯¬å¿ƒä¸”å®ˆé¢¨éœœé€€", "é‚„èƒ½ä¾èˆŠä¿å¹³å®‰"] },
            { id: "ç¬¬ä¸‰åç±¤", code: "æˆŠæˆŒ", lines: ["æ¼¸æ¼¸è„«å‡ºè¦‹å¤ªå¹³", "ä¸é ˆç¥ˆç¦±å¿ƒè‡ªå®‰", "çœ‹çœ‹å³ä¾¿è¦‹æ˜æœˆ", "åé¡¯æœ‰æ„åœ¨ä¸­å¤®"] },
            { id: "ç¬¬ä¸‰åä¸€ç±¤", code: "å·±ä¸‘", lines: ["ç¦å¦‚æ±æµ·å£½å¦‚å±±", "å›çˆ¾ä½•é ˆè‹¦ä¸­é–“", "å¯Œè²´ç”±å¤©ä¸å¯æ±‚", "è¬äº‹æ¸…å‰ä¿å¹³å®‰"] },
            { id: "ç¬¬ä¸‰åäºŒç±¤", code: "å·±å¯", lines: ["é¾è™ç›¸éš¨åœ¨æ·±å±±", "å›çˆ¾ä½•é ˆè‹¦ä¸­é–“", "å¯Œè²´ç”±å¤©ä¸å¯æ±‚", "è¬äº‹æ¸…å‰ä¿å¹³å®‰"] },
            { id: "ç¬¬ä¸‰åä¸‰ç±¤", code: "å·±å·³", lines: ["æ¬²å»é•·æ±Ÿæ°´é—ŠèŒ«", "å‰é€”æœªå¾—æ„å¦‚ä½•", "è‹¥å¾—è²´äººå¤šå¾—åˆ©", "å’Œåˆè‡ªæœ‰å…©åˆ†æ˜"] },
            { id: "ç¬¬ä¸‰åå››ç±¤", code: "å·±æœª", lines: ["å±éšªé«˜å±±è¡Œéç›¡", "è«å«ŒèˆŸè»Šè·¯åˆé›£", "å›çˆ¾å¯¬å¿ƒä¸”è‡ªç”±", "è¬äº‹æ¸…å‰ä¿å¹³å®‰"] },
            { id: "ç¬¬ä¸‰åäº”ç±¤", code: "å·±é…‰", lines: ["æ­¤äº‹ä½•é ˆç”¨å¿ƒæ©Ÿ", "å‰é€”è®Šæ€ªè‡ªç„¶çŸ¥", "çœ‹çœ‹é‹ªåœ°é»ƒé‡‘æ»¿", "æ­¤å¾Œç¶“ç‡Ÿåˆ©ä¸ç–‘"] },
            { id: "ç¬¬ä¸‰åå…­ç±¤", code: "å·±äº¥", lines: ["ç¦å¦‚æ±æµ·å£½å¦‚å±±", "å›çˆ¾ä½•é ˆè‹¦ä¸­é–“", "å¯Œè²´ç”±å¤©ä¸å¯æ±‚", "è¬äº‹æ¸…å‰ä¿å¹³å®‰"] },
            { id: "ç¬¬ä¸‰åä¸ƒç±¤", code: "åºšå­", lines: ["é‹é€¢å¾—æ„èº«é¡¯è®Š", "å›çˆ¾èº«ä¸­çš†æœ‰ç›Š", "ä¸€å‘å‰é€”é€šå¤§é“", "è¬äº‹æ¸…å‰ä¿å¹³å®‰"] },
            { id: "ç¬¬ä¸‰åå…«ç±¤", code: "åºšå¯…", lines: ["åé¡¯æœ‰æ„åœ¨ä¸­å¤®", "ä¸é ˆç¥ˆç¦±å¿ƒè‡ªå®‰", "çœ‹çœ‹å³ä¾¿è¦‹æ˜æœˆ", "æ¼¸æ¼¸è„«å‡ºè¦‹å¤ªå¹³"] },
            { id: "ç¬¬ä¸‰åä¹ç±¤", code: "åºšè¾°", lines: ["æ„ä¸­è‹¥å•ç¥ä»™è·¯", "å‹¸çˆ¾ä¸”é€€è«å‘å‰", "é›–ç„¶æ­¤äº‹é›£æˆå°±", "ä¸”å®ˆå®‰éœä¿å¹³å®‰"] },
            { id: "ç¬¬å››åç±¤", code: "åºšåˆ", lines: ["å¹³ç”Ÿå¯Œè²´æˆç¥¿ä½", "å›çˆ¾ä½•é ˆè‹¦ä¸­é–“", "å¯Œè²´ç”±å¤©ä¸å¯æ±‚", "è¬äº‹æ¸…å‰ä¿å¹³å®‰"] },
            { id: "ç¬¬å››åä¸€ç±¤", code: "åºšç”³", lines: ["ä»Šæœä¸”å–œè¦‹å¤ªå¹³", "å‡¡äº‹å¿…æœ‰è²´äººæ‰¶", "è‹¥å¾—è²´äººå¤šå¾—åˆ©", "å’Œåˆè‡ªæœ‰å…©åˆ†æ˜"] },
            { id: "ç¬¬å››åäºŒç±¤", code: "åºšæˆŒ", lines: ["ä¸€é‡æ±Ÿæ°´ä¸€é‡å±±", "èª°çŸ¥æ­¤å»è·¯åˆé›£", "ä»»ä»–æ”¹æ›å®¶é–€æˆ¶", "èª°çŸ¥æ­¤å»è·¯åˆé›£"] },
            { id: "ç¬¬å››åä¸‰ç±¤", code: "è¾›ä¸‘", lines: ["ä¸€å¹´ä½œäº‹æ€¥å¦‚é£›", "å›çˆ¾å¯¬å¿ƒä¸”è‡ªç”±", "è‹¥å¾—è²´äººå¤šå¾—åˆ©", "å’Œåˆè‡ªæœ‰å…©åˆ†æ˜"] },
            { id: "ç¬¬å››åå››ç±¤", code: "è¾›å¯", lines: ["å®¢åˆ°å‰é€”å¤šå¾—åˆ©", "å›çˆ¾ä½•é ˆè‹¦ä¸­é–“", "å¯Œè²´ç”±å¤©ä¸å¯æ±‚", "è¬äº‹æ¸…å‰ä¿å¹³å®‰"] },
            { id: "ç¬¬å››åäº”ç±¤", code: "è¾›å·³", lines: ["èŠ±é–‹ä»Šå·²çµæˆæœ", "å¯Œè²´æ¦®è¯çµ‚åˆ°å®¶", "å›å­å°äººç›¸æœƒåˆ", "è¬äº‹æ¸…å‰ä¿å¹³å®‰"] },
            { id: "ç¬¬å››åå…­ç±¤", code: "è¾›æœª", lines: ["åŠŸåå¾—æ„ä¸Šå±¤æ¨“", "ä¸€å‘å‰é€”é€šå¤§é“", "è‹¥å¾—è²´äººå¤šå¾—åˆ©", "å’Œåˆè‡ªæœ‰å…©åˆ†æ˜"] },
            { id: "ç¬¬å››åä¸ƒç±¤", code: "è¾›é…‰", lines: ["å›çˆ¾å¯¬å¿ƒä¸”è‡ªç”±", "é–€åº­æ¸…å‰å®¶ç„¡æ†‚", "è²¡å¯¶è‡ªç„¶çµ‚æœ‰æœ›", "å‡¡äº‹å¿…æœ‰è²´äººæ‰¶"] },
            { id: "ç¬¬å››åå…«ç±¤", code: "è¾›äº¥", lines: ["é™½ä¸–ä¸çŸ¥é™°ä¸–äº‹", "å®˜æ³•å¦‚çˆä¸è‡ªç”±", "ä¸é ˆä½œç¦ä¸é ˆæ±‚", "ç”¨ç›¡å¿ƒæ©Ÿç¸½æœªä¼‘"] },
            { id: "ç¬¬å››åä¹ç±¤", code: "å£¬å­", lines: ["è¨€èªé›–å¤šä¸å¯å¾", "é¢¨é›²éœè™•æœªå®œå‹•", "æš—ä¸­è‡ªæœ‰è²´äººæ‰¶", "å›çˆ¾ä½•é ˆè‹¦ä¸­é–“"] },
            { id: "ç¬¬äº”åç±¤", code: "å£¬å¯…", lines: ["ä½›å‰ç™¼èª“ç„¡ç•°å¿ƒ", "ä¸”çœ‹å‰é€”å¾—å¥½éŸ³", "æ­¤ç‰©åŸä¾†æœ¬æ˜¯éµ", "ä¹Ÿèƒ½æˆé‡é¡¯ç¥å¥‡"] },
            { id: "ç¬¬äº”åä¸€ç±¤", code: "å£¬è¾°", lines: ["æ±è¥¿å—åŒ—ä¸å ªè¡Œ", "å‰é€”æœªå¾—æ„å¦‚ä½•", "è‹¥å¾—è²´äººå¤šå¾—åˆ©", "å’Œåˆè‡ªæœ‰å…©åˆ†æ˜"] },
            { id: "ç¬¬äº”åäºŒç±¤", code: "å£¬åˆ", lines: ["åŠŸåå¾—æ„ä¸Šå±¤æ¨“", "ä¸€å‘å‰é€”é€šå¤§é“", "è²¡å¯¶è‡ªç„¶çµ‚æœ‰æœ›", "è¬äº‹æ¸…å‰ä¿å¹³å®‰"] },
            { id: "ç¬¬äº”åä¸‰ç±¤", code: "å£¬ç”³", lines: ["çœ‹å›ä¾†å•å¿ƒä¸­äº‹", "ç©å–„ä¹‹å®¶æ…¶æœ‰é¤˜", "é‹äº¨è²¡æºå¦‚æ³‰æ¹§", "æ­¤å¾Œç¶“ç‡Ÿåˆ©ä¸ç–‘"] },
            { id: "ç¬¬äº”åå››ç±¤", code: "å£¬æˆŒ", lines: ["å­¤ç‡ˆå¯‚å¯‚å¤œæ²‰æ²‰", "è¬äº‹æ¸…å‰ä¿å¹³å®‰", "åªæå‘½å…§æœ‰å·®æ± ", "å…©å®¶åˆå’Œæ˜¯éå¸¸"] },
            { id: "ç¬¬äº”åäº”ç±¤", code: "ç™¸ä¸‘", lines: ["é ˆçŸ¥é€²é€€è«é²ç–‘", "çœ‹çœ‹é‹ªåœ°é»ƒé‡‘æ»¿", "è‹¥å¾—è²´äººå¤šå¾—åˆ©", "å’Œåˆè‡ªæœ‰å…©åˆ†æ˜"] },
            { id: "ç¬¬äº”åå…­ç±¤", code: "ç™¸å¯", lines: ["ç—…ä¸­è‹¥å¾—è‹¦å¿ƒå‹", "åˆ°åº•çµ‚é ˆè¦‹å¤ªå¹³", "è‹¥å¾—è²´äººå¤šå¾—åˆ©", "å’Œåˆè‡ªæœ‰å…©åˆ†æ˜"] },
            { id: "ç¬¬äº”åä¸ƒç±¤", code: "ç™¸å·³", lines: ["å‹¸å›æŠŠå®šå¿ƒè«è™›", "å¤©è¨»è¡£ç¥¿è‡ªæœ‰é¤˜", "å’Œåˆé‡é‡å¸¸å‰æ…¶", "é€ä¾†å…’å¥³æ»¿é–€åº­"] },
            { id: "ç¬¬äº”åå…«ç±¤", code: "ç™¸æœª", lines: ["è›‡èº«å¾—æ„é¡¯å…¶èƒ½", "çœ‹çœ‹é‹ªåœ°é»ƒé‡‘æ»¿", "è‹¥å¾—è²´äººå¤šå¾—åˆ©", "å’Œåˆè‡ªæœ‰å…©åˆ†æ˜"] },
            { id: "ç¬¬äº”åä¹ç±¤", code: "ç™¸é…‰", lines: ["æ„ä¸­è‹¥å•ç¥ä»™è·¯", "å‹¸çˆ¾ä¸”é€€è«å‘å‰", "é›–ç„¶æ­¤äº‹é›£æˆå°±", "ä¸”å®ˆå®‰éœä¿å¹³å®‰"] },
            { id: "ç¬¬å…­åç±¤", code: "ç™¸äº¥", lines: ["æœˆå‡ºå…‰è¼æœ¬æ¸…å‰", "æµ®é›²ç¸½æ˜¯è”½é™°è‰²", "æˆ¶å…§ç”¨å¿ƒå†ä½œç¦", "ç•¶å®˜åˆ†ç†ä¾¿ç„¡å¤±"] }
        ];

        let state = {
            question: "",
            currentStick: null
        };

        function switchStep(id) {
            ['step-input', 'step-draw', 'step-jiao', 'step-result'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            const active = document.getElementById(id);
            active.classList.remove('hidden');
            active.classList.add('fade-in');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toDraw() {
            state.question = document.getElementById('question').value.trim();
            if(!state.question) {
                return showMessage("è«‹å…ˆè¼¸å…¥æ‚¨çš„æå•ã€‚");
            }
            switchStep('step-draw');
        }

        function startShake() {
            const barrel = document.getElementById('barrel');
            const btn = document.getElementById('shake-btn');
            btn.disabled = true;
            barrel.classList.add('stick-box-anim');
            
            setTimeout(() => {
                barrel.classList.remove('stick-box-anim');
                const cryptoArray = new Uint32Array(1);
                window.crypto.getRandomValues(cryptoArray);
                const randomIndex = cryptoArray[0] % poemLibrary.length;
                
                state.currentStick = poemLibrary[randomIndex];
                document.getElementById('target-stick').innerText = `${state.currentStick.id}`;
                switchStep('step-jiao');
                btn.disabled = false;
            }, 1500);
        }

        function throwJiao() {
            const btn = document.getElementById('jiao-btn');
            const resText = document.getElementById('jiao-result');
            btn.disabled = true;
            
            const r1 = Math.random() > 0.5;
            const r2 = Math.random() > 0.5;
            
            document.getElementById('j1').style.transform = `translateY(-100px) rotate(${360 + Math.random()*720}deg)`;
            document.getElementById('j2').style.transform = `translateY(-100px) rotate(${-360 - Math.random()*720}deg)`;
            
            setTimeout(() => {
                document.getElementById('j1').style.transform = "none";
                document.getElementById('j2').style.transform = "none";
                
                r1 ? document.getElementById('j1').classList.add('flat') : document.getElementById('j1').classList.remove('flat');
                r2 ? document.getElementById('j2').classList.add('flat') : document.getElementById('j2').classList.remove('flat');
                
                if (r1 !== r2) {
                    resText.innerHTML = "<span class='text-green-700'>ã€è–ç­Šã€‘ç¥éˆæ‡‰å…ï¼</span>";
                    setTimeout(getFinalResult, 1000);
                } else {
                    const msg = (r1 && r2) ? "ã€ç¬‘ç­Šã€‘ç¥éˆç¬‘è€Œä¸èª..." : "ã€é™°ç­Šã€‘ç¥éˆæš«ä¸èªåŒã€‚";
                    resText.innerHTML = `<span class='text-red-700'>${msg}</span>`;
                    setTimeout(() => { 
                        switchStep('step-draw'); 
                        btn.disabled = false; 
                        resText.innerText = ""; 
                    }, 1500);
                }
            }, 700);
        }

        async function getFinalResult() {
            switchStep('step-result');
            document.getElementById('final-stick-id').innerText = `${state.currentStick.id} (${state.currentStick.code})`;
            
            const poemBox = document.getElementById('poem-box');
            poemBox.innerHTML = '';
            state.currentStick.lines.forEach(line => {
                const col = document.createElement('div');
                col.className = 'vertical-column';
                for(let char of line) {
                    const span = document.createElement('span');
                    span.innerText = char;
                    col.appendChild(span);
                }
                poemBox.appendChild(col);
            });

            const aiTextBox = document.getElementById('ai-text');
            aiTextBox.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8">
                    <div class="lotus-loader mb-4"></div>
                    <p class="text-stone-500 animate-pulse">æ­£åœ¨ç‚ºæ‚¨é€šéˆè§£è®€ä¸­...</p>
                </div>
            `;

            const systemPrompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šå°ç£æ°‘é–“å…­åç”²å­ç±¤è©©çš„è§£ç±¤å¤§å¸«ã€Œä¸ä¸ã€ã€‚
å›ç­”å¿…é ˆåŒ…å«ï¼š
1. ã€ç±¤è©©å…¸æ•…ã€‘ï¼šæä¾›æ­¤ç±¤è™Ÿå°æ‡‰çš„æ•…äº‹ã€‚
2. ã€è©©æ„è©³è§£ã€‘ï¼šç”¨ç™½è©±æ–‡è§£é‡‹è©©å¥ã€‚
3. ã€ä¸ä¸å»ºè­°ã€‘ï¼šé‡å°æå•æä¾›æŒ‡å¼•ã€‚
é¦–å¥å¿…é ˆåŒ…å«ã€Œä¸ä¸ç‚ºæ‚¨è§£ç­”ã€ã€‚å­—æ•¸ 250 å­—å·¦å³ã€‚`;

            try {
                const resultText = await callGeminiAPI(`å¼Ÿå­å•é¡Œï¼š${state.question}\næŠ½å¾—ç±¤è©©ï¼š${state.currentStick.id} (${state.currentStick.code}) - è©©äº‘ï¼šã€Œ${state.currentStick.lines.join('ï¼Œ')}ã€`, systemPrompt);
                aiTextBox.innerText = resultText || "ä¸ä¸ç›®å‰æ„Ÿæ‡‰æ¨¡ç³Šï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
            } catch (e) {
                aiTextBox.innerHTML = `<p class="text-red-800">é€£ç·šå¤±æ•—ã€‚æ­¤ç±¤é¦–å¥ã€Œ${state.currentStick.lines[0]}ã€æ„æ—¨ç•¶å‰è™•å¢ƒï¼Œè«‹å¯¬å¿ƒå¾…ä¹‹ã€‚</p>`;
            }
        }

        async function callGeminiAPI(prompt, systemInstruction) {
            let retries = 5;
            let delay = 1000;
            while (retries > 0) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemInstruction }] }
                        })
                    });
                    if (!response.ok) throw new Error('API Error');
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) {
                    retries--;
                    if (retries === 0) throw e;
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
        }

        function resetGame() {
            state = { question: "", currentStick: null };
            document.getElementById('question').value = "";
            document.getElementById('jiao-result').innerText = "";
            switchStep('step-input');
        }

        function showMessage(msg) {
            const div = document.createElement('div');
            div.className = "fixed top-10 left-1/2 -translate-x-1/2 bg-red-800 text-white px-6 py-3 rounded-full shadow-2xl z-50 text-sm font-bold animate-bounce";
            div.innerText = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
    </script>
</body>
</html>

<p><a href="index.html">å›åˆ°é¦–é </a></p>



